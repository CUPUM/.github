name: Parse Contact Form
on:
  workflow_call:

jobs:
  parse_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set GH_TOKEN from ORG_PAT
        run: echo "GH_TOKEN=${{ secrets.ORG_PAT }}" >> $GITHUB_ENV
        env:
          ORG_PAT: ${{ secrets.ORG_PAT }}

      - name: Debug GH_TOKEN Before Authentication
        run: |
          if [[ -z "$GH_TOKEN" ]]; then
            echo "❌ ERROR: GH_TOKEN is empty!"
            exit 1
          fi
          echo "✅ GH_TOKEN is set."

      - name: Check Authentication Status
        run: |
          echo "🔍 Checking authentication with gh auth status..."
          gh auth status || { echo "❌ ERROR: Not authenticated!"; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}

      - name: Retrieve Project Node ID
        id: get_project_id
        run: |
          PROJECT_NODE_ID=$(gh api graphql -F organization="CUPUM" -f query='
          query($organization: String!) {
            organization(login: $organization) {
              projectV2(number: 179) {
                id
              }
            }
          }' --jq '.data.organization.projectV2.id')

          if [[ -z "$PROJECT_NODE_ID" ]]; then
            echo "❌ ERROR: Failed to retrieve project node ID!"
            exit 1
          fi

          echo "✅ Project Node ID: $PROJECT_NODE_ID"
          echo "PROJECT_NODE_ID=$PROJECT_NODE_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}

      # Fetching field IDs one-by-one to completely avoid union-related errors
      - name: Retrieve First Name Field ID
        id: get_first_name_field
        run: |
          FIRST_NAME_FIELD_ID=$(gh api graphql -F projectId="$PROJECT_NODE_ID" -f query='
          query($projectId: ID!) {
            node(id: $projectId) {
              ... on ProjectV2 {
                fields(first: 50) {
                  nodes {
                    id
                    name
                  }
                }
              }
            }
          }' --jq '.data.node.fields.nodes[] | select(.name=="First Name") | .id')

          if [[ -z "$FIRST_NAME_FIELD_ID" || "$FIRST_NAME_FIELD_ID" == "null" ]]; then
            echo "❌ ERROR: Failed to retrieve First Name field ID!"
            exit 1
          fi

          echo "✅ First Name Field ID: $FIRST_NAME_FIELD_ID"
          echo "FIRST_NAME_FIELD_ID=$FIRST_NAME_FIELD_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}

      - name: Retrieve Last Name Field ID
        id: get_last_name_field
        run: |
          LAST_NAME_FIELD_ID=$(gh api graphql -F projectId="$PROJECT_NODE_ID" -f query='
          query($projectId: ID!) {
            node(id: $projectId) {
              ... on ProjectV2 {
                fields(first: 50) {
                  nodes {
                    id
                    name
                  }
                }
              }
            }
          }' --jq '.data.node.fields.nodes[] | select(.name=="Last Name") | .id')

          if [[ -z "$LAST_NAME_FIELD_ID" || "$LAST_NAME_FIELD_ID" == "null" ]]; then
            echo "❌ ERROR: Failed to retrieve Last Name field ID!"
            exit 1
          fi

          echo "✅ Last Name Field ID: $LAST_NAME_FIELD_ID"
          echo "LAST_NAME_FIELD_ID=$LAST_NAME_FIELD_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}

      - name: Retrieve Organization Field ID
        id: get_organization_field
        run: |
          ORGANIZATION_FIELD_ID=$(gh api graphql -F projectId="$PROJECT_NODE_ID" -f query='
          query($projectId: ID!) {
            node(id: $projectId) {
              ... on ProjectV2 {
                fields(first: 50) {
                  nodes {
                    id
                    name
                  }
                }
              }
            }
          }' --jq '.data.node.fields.nodes[] | select(.name=="Organization") | .id')

          if [[ -z "$ORGANIZATION_FIELD_ID" || "$ORGANIZATION_FIELD_ID" == "null" ]]; then
            echo "❌ ERROR: Failed to retrieve Organization field ID!"
            exit 1
          fi

          echo "✅ Organization Field ID: $ORGANIZATION_FIELD_ID"
          echo "ORGANIZATION_FIELD_ID=$ORGANIZATION_FIELD_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}

      - name: Extract Issue Form Data
        id: extract_issue_form
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' <<< '${{ toJson(github.event) }}')

          FIRST_NAME=$(echo "$ISSUE_BODY" | awk -F "\*\*First Name\*\*" '{print $2}' | awk -F "\n" '{print $1}' | xargs)
          LAST_NAME=$(echo "$ISSUE_BODY" | awk -F "\*\*Last Name\*\*" '{print $2}' | awk -F "\n" '{print $1}' | xargs)
          ORGANIZATION=$(echo "$ISSUE_BODY" | awk -F "\*\*Organization\*\*" '{print $2}' | awk -F "\n" '{print $1}' | xargs)

          echo "FIRST_NAME=$FIRST_NAME" >> $GITHUB_ENV
          echo "LAST_NAME=$LAST_NAME" >> $GITHUB_ENV
          echo "ORGANIZATION=$ORGANIZATION" >> $GITHUB_ENV
